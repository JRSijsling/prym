/* Main simplification steps */
SetVerbose("PlaneQuartic", 1);

R<x> := PolynomialRing(Rationals());
f := x^2 - x - 15;
K<r> := NumberField(f);
ZZK := Integers(K);
R<x,y,z> := PolynomialRing(K, 3);

F := (6210110824548921989850263245372753396353806712430454802680643170946993888*r - 27356507343246589550835420893650823456734384761001116403554104572839488364)*x^4 + (11052274666009812369768213224410425564317060868963251599613871468750000*r - 48686270088283698666823568179136587387377890030526338825647484730750000)*x^3*y + (-845842314704745661699512862791500663627744031630160209744983290107000*r + 3726000688819743583891209351922166987190884936088523421903763330510000)*x^3*z + (8318101609693207417047103674565797232569121784073500011576171875000*r - 36644063631882267673969915374061684942871614470845028264843750000000)*x^2*y^2 + (-2457990276353339943787264554436836805131154710645782797589625000000*r + 10827593860508487926893885353047190377885297009129861950941234375000)*x^2*y*z + (326558598722749566663810371291373360317819273750002516773500625000*r - 1438537981431815331068233954975423763733701205758502155007849750000)*x^2*z^2 + (3389096120629073924149536549256532902514477419738769531250000000*r - 14924116716849994441376671246053750013571919201104553222656250000)*x*y^3 + (1360899108742960620005157681212173861361804702709135498046875000*r - 5995527514171071172709541731950782529431105224040608642578125000)*x*y^2*z + (817286289707938409792513073143915230451244476784666761718750000*r - 3600272032965077958858143479306670056752088247743846306640625000)*x*y*z^2 + (-27844289020540541753568929354024779034108489085911596171875000*r + 122657140931343238735275993364539758352077461067689583015625000)*x*z^3 + (578913976305813570655728246683201809823951005935668945312500*r - 2587637032498458172893071975310078671316399812698364257812500)*y^4 + (143317362045937921558244335092859076882143398284912109375000*r - 633418727084374262902242501534473697373541107177734375000000)*y^3*z + (100105738249792236317588696268951821445075880279541015625000*r - 441069816545920639692977413563534497155933003143310546875000)*y^2*z^2 + (15417121920249437332293413294278870057376067736083984375000*r - 67915943086870853749604617208563573060155694168945312500000)*y*z^3 + (27307965693753899931844585236559742132400430059592529296875*r - 120295011428448504225733593228325497613945662503643310546875)*z^4;

test, d := IsPrincipal(ideal< ZZK | Coefficients(F) >);
F /:= d;
NF := #Sprint(F);

I := DixmierOhnoInvariants(F);
Fac := Factorization(ideal< ZZK | I[#I] >);
Fac := Reverse(Fac);
print Fac;
print #Fac;

load "elsenhans-principal.m";
N := 8;
v := Place(ideal< ZZK | Fac[N][1] >);
//for tup in Fac[N..N] do
for tup in Fac do
    print tup;
    test, gen := IsPrincipal(tup[1]);
    pi := K ! ZZK ! Eltseq(gen);
    F := MinimizePlaneQuartic(F, pi);
end for;

/*
D := [-2..2];
repeat
    T := Matrix(K, [ [ K ! ZZK ! [ Random(D), Random(D) ] : j in [1..3] ] : i in [1..3] ]);
until IsUnit(ZZK ! Determinant(T));
F := F^T;
for tup in Fac[N..N] do
    print tup;
    test, gen := IsPrincipal(tup[1]);
    pi := K ! ZZK ! Eltseq(gen);
    F := MinimizePlaneQuartic(F, pi);
end for;
*/

I := DixmierOhnoInvariants(F);
Fac := Factorization(ideal< ZZK | I[#I] >);
Fac := Reverse(Fac);
print #Fac;
print Fac;
print Valuation(I[#I], v);

NF := #Sprint(F);
print NF;
D := [-3..3];
while true do
    repeat
        T := Matrix(K, [ [ K ! ZZK ! [ Random(D), Random(D) ] : j in [1..3] ] : i in [1..3] ]);
    until IsUnit(ZZK ! Determinant(T));
    G := F^T;
    test, d := IsPrincipal(ideal< ZZK | Coefficients(G) >);
    G /:= d;
    NG := #Sprint(G);
    
    /*
    I := DixmierOhnoInvariants(F);
    J := DixmierOhnoInvariants(G);
    NmF := Abs(Norm(I[#I]));
    NmG := Abs(Norm(J[#J]));
    */

    //if NG lt NF and NmG lt NmF then
    if NG lt NF then
        F := G; NF := NG;
        PrintFileMagma("Fs.m", F);
        print NF;
    end if;
end while;
